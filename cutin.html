<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MegaFuture — Story Modal (Timed Cues)</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#000;
      --text:rgba(255,255,255,.72);
      --panel:rgba(0,0,0,.82);
      --panel-border:rgba(255,255,255,.08);
    }

    html, body{
      margin:0;
      height:100%;
      background:var(--bg);
      overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    #mfModal{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
      background:#000;
      user-select:none;
      overflow:hidden;
    }

    .stage{
      width:min(92vw, 1100px);
      aspect-ratio:16/9;
      position:relative;
      display:grid;
      place-items:center;
      border-radius:18px;
      overflow:hidden;
      background:#000;
    }

    /* ===== Full background behind actors (no crop) ===== */
    .bgLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index: 1;
      background: url("images/blood_bay.png") center center no-repeat;
      background-size: contain;

      opacity: 0;
      transform: scale(1);
      transition:
        opacity 2800ms ease,
        transform 0ms linear; /* JS will set timing when shrink begins */
      will-change: transform, opacity;
      transform-origin: center center;
    }
    .bgLayer.isVisible{ opacity: 1; }

    .charLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index: 2;

      opacity: 0;
      transition: opacity 1400ms ease;
    }
    .charLayer.isVisible{ opacity: 1; }

    .captionBar{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height:28%;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: 0 18px 18px;
      box-sizing:border-box;
      background: linear-gradient(to top, rgba(0,0,0,.92), rgba(0,0,0,.10) 70%, rgba(0,0,0,0));
      pointer-events:none;
      z-index: 3;
    }

    .captionPanel{
      width:min(92%, 900px);
      min-height: 84px;
      max-height: 160px;
      padding: 14px 16px;
      box-sizing:border-box;
      border-radius: 14px;
      background: var(--panel);
      border: 1px solid var(--panel-border);
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    #captionText{
      font-family: "Orbitron", system-ui, sans-serif;
      font-weight: 500;
      font-size: clamp(12px, 1.45vw, 16px);
      line-height: 1.45;
      letter-spacing: 0.02em;
      text-align:center;
      color: var(--text);
      white-space: pre-wrap;
      min-height: 1.5em;
      width:100%;
      transition: opacity 260ms ease;
    }

    /* Cards: auto-sized to image, no cropping */
    .card{
      position:absolute;
      top: 10%;
      display:inline-block;
      width:auto;
      height:auto;
      background: transparent;
      border: none;
      box-shadow: none;
      will-change: transform;
      transform-origin: center center;
    }

    #amadeusCard{ z-index: 4; }
    #aristocratCard{ z-index: 3; }

    .card img{
      display:block;
      width:auto;
      height:auto;
      max-width: min(40vw, 520px);
      max-height: min(58vh, 600px);
      object-fit: contain;
      background: transparent;
    }

    #debug{
      position:fixed;
      left:12px;
      top:12px;
      padding:8px 10px;
      border-radius:10px;
      color:rgba(255,255,255,.55);
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space:pre;
      user-select:none;
      pointer-events:none;
      display:none;
    }
  </style>
</head>

<body>
  <div id="debug"></div>

  <div id="mfModal">
    <div class="stage" id="stage">
      <div class="bgLayer" id="bgLayer" aria-hidden="true"></div>

      <div class="charLayer" id="charLayer">
        <div class="card" id="amadeusCard" aria-hidden="true"></div>
        <div class="card" id="aristocratCard" aria-hidden="true"></div>
      </div>

      <div class="captionBar">
        <div class="captionPanel">
          <div id="captionText"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    const AMADEUS_IMG    = "images/amadeus.png";
    const ARISTOCRAT_IMG = "images/aristocrat.png";

    // Fade cues (match your exact line)
    const BG_FADE_ON_TEXT = "It is a time when the sun burns weak and red.";
    const ACTORS_FADE_ON_EXACT = "These \"men,\" as they once fashioned themselves.";

    // Motion timing (same as your previous)
    const MOVE_MS = 24000;
    const SOLO_SLIDE_MS = 8000;

    const ZOOM_FROM = 1.00;
    const ZOOM_TO   = 1.22;
    const ZOOM_EASE = "linear";

    // Background shrink should match Amadeus zoom timing
    const BG_SCALE_FROM = 1.00;
    // choose a pleasing inverse (not literal inverse math)
    const BG_SCALE_TO   = 0.88;

    const MOVE_EASE = "cubic-bezier(0.10, 0.00, 0.90, 1.00)";
    const SOLO_EASE = "cubic-bezier(0.10, 0.00, 0.90, 1.00)";

    const DELETE_BLUE_ON_TEXT = "In their infighting, only one remained.";
    const EXTRA_HOLD_BEFORE_DELETE_MS = 5000;
    const DELAY_BEFORE_RED_RECENTER_MS = 2000;

    const storyCues = [
      { text: "It is a time when the sun burns weak and red.", ms: 4000 },
      { text: "The days are long and the seasons are cold.", ms: 5000 },
      { text: "This is The MegaFuture", ms: 3000 },
      { text: "", ms: 900 },

      { text: "You are of the two remaining immortals.", ms: 4000 },
      { text: "A clone, an experiment, a prisoner.", ms: 4000 },
      { text: "", ms: 900 },

      { text: "These \"men,\" as they once fashioned themselves.", ms: 4000 },
      { text: "Poisoned the Earth.", ms: 3000 },
      { text: "Hardened their bodies.", ms: 3000 },
      { text: "And created a cabal of everlasting corruption.", ms: 4000 },
      { text: "In their infighting, only one remained.", ms: 4000 },
      { text: "", ms: 2000 },

      { text: "A single authority with absolute control over Earth’s biosphere.", ms: 3400 },
      { text: "Over life.", ms: 2300 },
      { text: "Over death.", ms: 2300 },
      { text: "", ms: 1800 },

      { text: "Over you.", ms: 3400 },
      { text: "", ms: 900 },

      { text: "Your goal is to escape this madness.", ms: 3400 },
      { text: "but...", ms: 3000 },
      { text: "is it even possible?", ms: 3400 }
    ];

    const stage = document.getElementById("stage");
    const captionText = document.getElementById("captionText");
    const debugEl = document.getElementById("debug");

    const bgLayer = document.getElementById("bgLayer");
    const charLayer = document.getElementById("charLayer");

    const amadeusCard = document.getElementById("amadeusCard");
    let aristocratCard = document.getElementById("aristocratCard");

    const wait = (ms) => new Promise(r => setTimeout(r, ms));

    function setDebug(txt){
      if (!debugEl || debugEl.style.display === "none") return;
      debugEl.textContent = txt;
    }

    function setCaptionText(str){
      captionText.style.opacity = "0";
      const safe = (str === "") ? " " : str;
      setTimeout(() => {
        captionText.textContent = safe;
        captionText.style.opacity = "1";
      }, 170);
    }

    function mountImage(cardEl, url){
      return new Promise((resolve) => {
        const img = new Image();
        img.decoding = "async";
        img.loading = "eager";
        img.src = url;

        img.onload = () => {
          cardEl.innerHTML = "";
          cardEl.appendChild(img);
          resolve(true);
        };

        img.onerror = () => resolve(false);
      });
    }

    // ---- background transform management ----
    let bgScale = BG_SCALE_FROM;

    function applyBgTransform(){
      bgLayer.style.transform = `scale(${bgScale})`;
    }
    function setBgScale(s){
      bgScale = s;
      applyBgTransform();
    }

    // ---- transform management (translate + scale together) ----
    let amadeusX = 0;
    let amadeusScale = ZOOM_FROM;

    function applyAmadeusTransform(){
      amadeusCard.style.transform = `translate3d(${amadeusX}px, 0px, 0px) scale(${amadeusScale})`;
    }
    function setAmadeusX(x){ amadeusX = x; applyAmadeusTransform(); }
    function setAmadeusScale(s){ amadeusScale = s; applyAmadeusTransform(); }

    // ---- positions / motion ----
    function computePositions(){
      const rect = stage.getBoundingClientRect();
      const aRect = amadeusCard.getBoundingClientRect();
      const cardW = aRect.width;

      const padX = Math.max(18, rect.width * 0.035);

      const leftStartX  = padX;
      const rightStartX = rect.width - padX - cardW;

      const leftEndX  = rightStartX;
      const rightEndX = leftStartX;

      const centerX = (rect.width - cardW) / 2;

      return { leftStartX, rightStartX, leftEndX, rightEndX, centerX };
    }

    function setCardX(cardEl, x){
      cardEl.style.transform = `translate3d(${x}px, 0px, 0px)`;
    }

    // default placement (NO animation): Amadeus left, Aristocrat right
    function snapToDefaultPositions(){
      const pos = computePositions();
      amadeusCard.style.transition = "none";
      if (aristocratCard && aristocratCard.isConnected) aristocratCard.style.transition = "none";

      setAmadeusScale(ZOOM_FROM);
      setAmadeusX(pos.leftStartX);

      if (aristocratCard && aristocratCard.isConnected){
        setCardX(aristocratCard, pos.rightStartX);
      }

      // baseline background scale too
      bgLayer.style.transition = "none";
      setBgScale(BG_SCALE_FROM);

      void amadeusCard.offsetHeight; // flush
    }

    function animateSwapOnce(){
      const pos = computePositions();

      amadeusCard.style.transition = `transform ${MOVE_MS}ms ${MOVE_EASE}`;
      if (aristocratCard && aristocratCard.isConnected){
        aristocratCard.style.transition = `transform ${MOVE_MS}ms ${MOVE_EASE}`;
      }

      requestAnimationFrame(() => {
        setAmadeusX(pos.leftEndX);
        if (aristocratCard && aristocratCard.isConnected){
          setCardX(aristocratCard, pos.rightEndX);
        }
      });
    }

    function animateRedToCenter(){
      const pos = computePositions();
      amadeusCard.style.transition = `transform ${SOLO_SLIDE_MS}ms ${SOLO_EASE}`;
      requestAnimationFrame(() => setAmadeusX(pos.centerX));
    }

    function isDeleteCueText(text){
      if (!text) return false;
      return text === DELETE_BLUE_ON_TEXT || text.includes(DELETE_BLUE_ON_TEXT);
    }

    function calcZoomDurationAfterDelete(){
      const idx = storyCues.findIndex(c => isDeleteCueText(c.text));
      if (idx === -1) return 0;
      let sum = 0;
      for (let i = idx + 1; i < storyCues.length; i++){
        sum += (storyCues[i]?.ms || 0);
      }
      return Math.max(0, sum);
    }

    function startAmadeusZoomUntilStoryEnds(){
      const zoomDuration = calcZoomDurationAfterDelete() / 2.5;
      if (zoomDuration <= 0){
        setAmadeusScale(ZOOM_TO);
        setBgScale(BG_SCALE_TO);
        return;
      }

      // sync both transitions (same duration + same easing)
      amadeusCard.style.transition = `transform ${zoomDuration}ms ${ZOOM_EASE}`;
      bgLayer.style.transition     = `transform ${zoomDuration}ms ${ZOOM_EASE}`;

      requestAnimationFrame(() => {
        setAmadeusScale(ZOOM_TO);
        setBgScale(BG_SCALE_TO);
      });
    }

    let blueDeleted = false;
    let zoomStarted = false;

    function deleteBlueNow(){
      if (blueDeleted) return;
      blueDeleted = true;

      if (aristocratCard && aristocratCard.isConnected){
        aristocratCard.remove();
      }
      aristocratCard = null;

      // ✅ wait 2 seconds before Amadeus slides back to center
      setTimeout(() => {
        animateRedToCenter();

        if (!zoomStarted){
          zoomStarted = true;
          // zoom (and bg shrink) begins when red finishes recenter
          setTimeout(() => startAmadeusZoomUntilStoryEnds(), SOLO_SLIDE_MS);
        }
      }, DELAY_BEFORE_RED_RECENTER_MS);
    }

    // ---- staged start ----
    let bgShown = false;
    let actorsShown = false;
    let motionStarted = false;

    function showBackgroundIfNeeded(text){
      if (bgShown) return;
      if (!text) return;
      if (text === BG_FADE_ON_TEXT || text.includes(BG_FADE_ON_TEXT)){
        bgShown = true;
        bgLayer.classList.add("isVisible");
      }
    }

    function showActorsAndStartMotionIfNeeded(text){
      if (actorsShown) return;
      if (!text) return;

      if (text === ACTORS_FADE_ON_EXACT || text.includes(ACTORS_FADE_ON_EXACT)){
        actorsShown = true;

        // fade in actors
        charLayer.classList.add("isVisible");

        // kick swap after they become visible
        if (!motionStarted){
          motionStarted = true;
          requestAnimationFrame(() => animateSwapOnce());
        }
      }
    }

    async function playStory(){
      for (let i = 0; i < storyCues.length; i++){
        const cue = storyCues[i];

        setCaptionText(cue.text);

        // background fades in during the first line
        showBackgroundIfNeeded(cue.text);

        // actors fade in AND the swap starts when the "These men..." line hits
        showActorsAndStartMotionIfNeeded(cue.text);

        if (isDeleteCueText(cue.text)){
          await wait(cue.ms + EXTRA_HOLD_BEFORE_DELETE_MS);
          deleteBlueNow();
          continue;
        }

        await wait(cue.ms);
      }
    }

    async function init(){
      // start hidden
      bgLayer.classList.remove("isVisible");
      charLayer.classList.remove("isVisible");

      // mount images (no placeholders)
      await Promise.all([
        mountImage(amadeusCard, AMADEUS_IMG),
        mountImage(aristocratCard, ARISTOCRAT_IMG)
      ]);

      // Put them in DEFAULT (red left, blue right), but hidden
      snapToDefaultPositions();

      // Start captions
      setCaptionText(storyCues[0]?.text ?? " ");
      // Trigger background immediately (since first line shows right away)
      showBackgroundIfNeeded(storyCues[0]?.text ?? "");

      // Story loop controls when actors appear + when motion begins
      playStory();

      addEventListener("resize", () => {
        // if motion hasn't started yet, keep default snap
        if (!motionStarted){
          snapToDefaultPositions();
        }
        setDebug("resized");
      }, { passive:true });
    }

    init().catch(err => {
      console.error(err);
      setCaptionText(" ");
    });
  })();
  </script>
</body>
</html>